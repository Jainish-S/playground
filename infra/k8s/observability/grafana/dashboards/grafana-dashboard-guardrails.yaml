# Grafana Dashboard for Guardrails Platform
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-guardrails
  namespace: observability
  labels:
    grafana_dashboard: "1"
data:
  guardrails.json: |
    {
      "annotations": {"list": []},
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "s"
            }
          },
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
          "id": 1,
          "options": {"legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [
            {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "histogram_quantile(0.50, sum(rate(guardrail_request_latency_seconds_bucket[5m])) by (le))", "legendFormat": "p50", "refId": "A"},
            {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "histogram_quantile(0.95, sum(rate(guardrail_request_latency_seconds_bucket[5m])) by (le))", "legendFormat": "p95", "refId": "B"},
            {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "histogram_quantile(0.99, sum(rate(guardrail_request_latency_seconds_bucket[5m])) by (le))", "legendFormat": "p99", "refId": "C"}
          ],
          "title": "Guardrail Request Latency (P50/P95/P99)",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "reqps"
            }
          },
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
          "id": 2,
          "options": {"legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [
            {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(envoy_cluster_upstream_rq_total{envoy_cluster_name=~\"guardrails-platform_guardrail-server.*\"}[1m]))", "legendFormat": "Total Requests (Ingress)", "refId": "A"}
          ],
          "title": "Overall Request Rate",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "s"
            }
          },
          "gridPos": {"h": 8, "w": 8, "x": 0, "y": 8},
          "id": 3,
          "options": {"legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [
            {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket{model_name=\"guardrail-server\", endpoint=\"/v1/validate\"}[1m])) by (le))", "legendFormat": "p50", "refId": "A"}
          ],
          "title": "Guardrail Server HTTP Latency P50 (End-to-End)",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "s"
            }
          },
          "gridPos": {"h": 8, "w": 8, "x": 8, "y": 8},
          "id": 8,
          "options": {"legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [
            {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{model_name=\"guardrail-server\", endpoint=\"/v1/validate\"}[1m])) by (le))", "legendFormat": "p95", "refId": "A"}
          ],
          "title": "Guardrail Server HTTP Latency P95 (End-to-End)",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "s"
            }
          },
          "gridPos": {"h": 8, "w": 8, "x": 16, "y": 8},
          "id": 9,
          "options": {"legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [
            {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{model_name=\"guardrail-server\", endpoint=\"/v1/validate\"}[1m])) by (le))", "legendFormat": "p99", "refId": "A"}
          ],
          "title": "Guardrail Server HTTP Latency P99 (End-to-End)",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "s"
            }
          },
          "gridPos": {"h": 8, "w": 8, "x": 0, "y": 16},
          "id": 10,
          "options": {"legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [
            {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket{endpoint=\"/predict\"}[1m])) by (le, model_name))", "legendFormat": "{{model_name}}", "refId": "A"}
          ],
          "title": "HTTP Request Duration P50 (End-to-End)",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "s"
            }
          },
          "gridPos": {"h": 8, "w": 8, "x": 8, "y": 16},
          "id": 11,
          "options": {"legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [
            {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket{endpoint=\"/predict\"}[1m])) by (le, model_name))", "legendFormat": "{{model_name}}", "refId": "A"}
          ],
          "title": "HTTP Request Duration P95 (End-to-End)",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "s"
            }
          },
          "gridPos": {"h": 8, "w": 8, "x": 16, "y": 16},
          "id": 12,
          "options": {"legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [
            {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{endpoint=\"/predict\"}[1m])) by (le, model_name))", "legendFormat": "{{model_name}}", "refId": "A"}
          ],
          "title": "HTTP Request Duration P99 (End-to-End)",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "s"
            }
          },
          "gridPos": {"h": 8, "w": 8, "x": 0, "y": 24},
          "id": 13,
          "options": {"legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [
            {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "histogram_quantile(0.50, sum(rate(model_inference_latency_seconds_bucket[1m])) by (le, model_name))", "legendFormat": "{{model_name}}", "refId": "A"}
          ],
          "title": "Inference Duration P50 (ML Only)",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "s"
            }
          },
          "gridPos": {"h": 8, "w": 8, "x": 8, "y": 24},
          "id": 14,
          "options": {"legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [
            {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "histogram_quantile(0.95, sum(rate(model_inference_latency_seconds_bucket[1m])) by (le, model_name))", "legendFormat": "{{model_name}}", "refId": "A"}
          ],
          "title": "Inference Duration P95 (ML Only)",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "palette-classic"},
              "custom": {"axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": {"legend": false, "tooltip": false, "viz": false}, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 1, "pointSize": 5, "scaleDistribution": {"type": "linear"}, "showPoints": "never", "spanNulls": false, "stacking": {"group": "A", "mode": "none"}, "thresholdsStyle": {"mode": "off"}},
              "mappings": [],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]},
              "unit": "s"
            }
          },
          "gridPos": {"h": 8, "w": 8, "x": 16, "y": 24},
          "id": 15,
          "options": {"legend": {"calcs": ["lastNotNull", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true}, "tooltip": {"mode": "multi", "sort": "desc"}},
          "targets": [
            {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "histogram_quantile(0.99, sum(rate(model_inference_latency_seconds_bucket[1m])) by (le, model_name))", "legendFormat": "{{model_name}}", "refId": "A"}
          ],
          "title": "Inference Duration P99 (ML Only)",
          "type": "timeseries"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [{"options": {"closed": {"color": "green", "index": 0, "text": "CLOSED"}, "half_open": {"color": "yellow", "index": 1, "text": "HALF_OPEN"}, "open": {"color": "red", "index": 2, "text": "OPEN"}}, "type": "value"}],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]}
            }
          },
          "gridPos": {"h": 4, "w": 6, "x": 0, "y": 32},
          "id": 4,
          "options": {"colorMode": "background", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
          "targets": [
            {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "guardrail_circuit_breaker_state{model_name=\"prompt-guard\"}", "legendFormat": "prompt-guard", "refId": "A"}
          ],
          "title": "Circuit Breaker: prompt-guard",
          "type": "stat"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [{"options": {"closed": {"color": "green", "index": 0, "text": "CLOSED"}, "half_open": {"color": "yellow", "index": 1, "text": "HALF_OPEN"}, "open": {"color": "red", "index": 2, "text": "OPEN"}}, "type": "value"}],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]}
            }
          },
          "gridPos": {"h": 4, "w": 6, "x": 6, "y": 32},
          "id": 5,
          "options": {"colorMode": "background", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
          "targets": [
            {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "guardrail_circuit_breaker_state{model_name=\"pii-detect\"}", "legendFormat": "pii-detect", "refId": "A"}
          ],
          "title": "Circuit Breaker: pii-detect",
          "type": "stat"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [{"options": {"closed": {"color": "green", "index": 0, "text": "CLOSED"}, "half_open": {"color": "yellow", "index": 1, "text": "HALF_OPEN"}, "open": {"color": "red", "index": 2, "text": "OPEN"}}, "type": "value"}],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]}
            }
          },
          "gridPos": {"h": 4, "w": 6, "x": 12, "y": 32},
          "id": 6,
          "options": {"colorMode": "background", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
          "targets": [
            {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "guardrail_circuit_breaker_state{model_name=\"hate-detect\"}", "legendFormat": "hate-detect", "refId": "A"}
          ],
          "title": "Circuit Breaker: hate-detect",
          "type": "stat"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "fieldConfig": {
            "defaults": {
              "color": {"mode": "thresholds"},
              "mappings": [{"options": {"closed": {"color": "green", "index": 0, "text": "CLOSED"}, "half_open": {"color": "yellow", "index": 1, "text": "HALF_OPEN"}, "open": {"color": "red", "index": 2, "text": "OPEN"}}, "type": "value"}],
              "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": null}]}
            }
          },
          "gridPos": {"h": 4, "w": 6, "x": 18, "y": 32},
          "id": 7,
          "options": {"colorMode": "background", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "reduceOptions": {"calcs": ["lastNotNull"], "fields": "", "values": false}, "textMode": "auto"},
          "targets": [
            {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "guardrail_circuit_breaker_state{model_name=\"content-class\"}", "legendFormat": "content-class", "refId": "A"}
          ],
          "title": "Circuit Breaker: content-class",
          "type": "stat"
        }
      ],
      "refresh": "30s",
      "schemaVersion": 38,
      "tags": ["guardrails", "ml", "llm"],
      "templating": {"list": []},
      "time": {"from": "now-1h", "to": "now"},
      "timepicker": {},
      "timezone": "",
      "title": "Guardrails Platform",
      "uid": "guardrails-dashboard",
      "version": 1,
      "weekStart": ""
    }
